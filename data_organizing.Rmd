---
title: "Milestone4"
author: "Nick Maxwell"
date: "10/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(gganimate)
library(rstanarm)
library(tidymodels)
library(RColorBrewer)
```

```{r}
justiceCentered <- 
  read_csv("SCDB_2020_01_justiceCentered_LegalProvision.csv",
           col_types = cols())

justiceIdeology <- read_csv("justices.csv",
                            col_types = cols())

```

```{r}
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

justiceIdeologyyear <- justiceIdeology %>% 
  mutate(year = term) %>% 
  select(-term)

roberts <- justiceCentered %>% 
  mutate(year = as.numeric(substrRight(dateDecision, 4))) %>% 
  filter(chief == "Roberts")

roberts_small <- roberts %>% 
  select(year, justiceName, justice, direction, issue, issueArea)

# Here, we'll just look at issueArea rather than issue - (the latter gets too
# granular too fast. I will, however, add options in the Shiny App to look at
# abortion and affirmative action, two hot-button issues. Abortion (including
# contraceptives) Issue = 50020, Affirmative Action = 20070

joined_data <- left_join(roberts_small, justiceIdeologyyear, 
                  by = c("year" = "year", 
                  "justice" = "justice",
                  "justiceName" = "justiceName")) %>% 
                   mutate(justiceName = recode(justiceName, 
                                      "SDOConnor" = "O'Connor",
                                      "JPStevens" = "Stevens",
                                      "AScalia" = "Scalia",
                                      "AMKennedy" = "Kennedy",
                                      "DHSouter" = "Souter",
                                      "CThomas" = "Thomas",
                                      "RBGinsburg" = "Ginsburg",
                                      "SGBreyer" = "Breyer",
                                      "JGRoberts" = "Roberts",
                                      "SAAlito" = "Alito",
                                      "SSotomayor" = "Sotomayor",
                                      "EKagan" = "Kagan",
                                      "NMGorsuch" = "Gorsuch",
                                      "BMKavanaugh" = "Kavanaugh")) %>% 
                 mutate(issueArea = recode(issueArea,
                                           "1" = "Criminal Procedure",
                                           "2" = "Civil Rights",
                                           "3" = "First Amendment",
                                           "4" = "Due Process",
                                           "5" = "Privacy",
                                           "6" = "Attorneys",
                                           "7" = "Unions",
                                           "8" = "Economic Activity",
                                           "9" = "Judicial Power",
                                           "10" = "Federalism",
                                           "11" = "Interstate Relations",
                                           "12" = "Federal Taxation",
                                           "13" = "Miscallaneous",
                                           "14" = "Private Action")) %>% 
                 mutate(direction = as.factor(recode(direction,
                                           "1" = "Conservative",
                                           "2" = "Liberal"))) %>% 
                 mutate(conservative = as.factor(ifelse(direction == 
                                                "Conservative", 1, 0))) %>% 
                 mutate(justiceName = as.factor(justiceName),
                        issueArea = as.factor(issueArea)) %>%
                 mutate(year = as.integer(year)) %>%
                 drop_na()


roberts_issue_area_votes <- joined_data %>% 
  mutate(conservative = as.integer(conservative) - 1) %>% 
  select(justiceName, issueArea, conservative) %>% 
  drop_na() %>% 
  group_by(issueArea, justiceName) %>% 
  summarize(percentage = mean(conservative)) 

colourCount <- length(unique(roberts_issue_area_votes$justiceName))
getPalette <- colorRampPalette(brewer.pal(n = 5, name = "Dark2"))

test_plot <- roberts_issue_area_votes %>% 
  filter(issueArea == "Attorneys") %>% 
    ggplot(aes(y = fct_reorder(justiceName, percentage), x = percentage, 
               fill = getPalette(colourCount))) +
      geom_col() 
  # scale_fill_brewer(palette = "RdYlBu")
test_plot


```

```{r}
new_tibble<-tibble(post_mn=rep(seq(-4,4,.1),13),
                   issueArea=rep(c("Criminal Procedure", "Civil Rights",
                    "First Amendment", "Due Process", "Privacy", "Attorneys",
                    "Unions", "Economic Activity", "Judicial Power", "Federalism",
                    "Federal Taxation", "Miscallaneous",
                    "Private Action"), each=81))

all_issue_ideology <- posterior_predict(prediction_model, newdata = new_tibble) %>%
    as_tibble() %>%
    mutate_all(as.numeric) %>% 
    summarize_all(mean) %>% 
    pivot_longer(cols = everything(),
               names_to = "ideology_score",
               values_to = "outcome") %>% 
    bind_cols(new_tibble) %>% 
    select(-ideology_score)
```


