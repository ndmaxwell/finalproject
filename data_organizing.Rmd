---
title: "Milestone4"
author: "Nick Maxwell"
date: "10/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(gganimate)
library(rstanarm)
library(tidymodels)
```

```{r}
justiceCentered <- 
  read_csv("SCDB_2020_01_justiceCentered_LegalProvision.csv")

justiceIdeology <- read_csv("justices.csv")

```

```{r}
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

justiceCenteredfixed <- justiceCentered %>% 
  mutate(year = as.numeric(substrRight(dateDecision, 4))) %>% 
  select(justiceName, direction, year) %>% 
  group_by(year, justiceName) %>% 
  summarize(ideology = mean(direction, na.rm = T), .groups = "drop") %>% 
  arrange(desc(ideology))

justiceIdeologyyear <- justiceIdeology %>% 
  mutate(year = term) %>% 
  select(-term)

roberts <- justiceCentered %>% 
  mutate(year = as.numeric(substrRight(dateDecision, 4))) %>% 
  filter(chief == "Roberts")

roberts_small <- roberts %>% 
  select(year, justiceName, justice, direction, issue, issueArea)

# Here, we'll just look at issueArea rather than issue - (the latter gets too
# granular too fast. I will, however, add options in the Shiny App to look at
# abortion and affirmative action, two hot-button issues. Abortion (including
# contraceptives) Issue = 50020, Affirmative Action = 20070

joined_data <- left_join(roberts_small, justiceIdeologyyear, 
                  by = c("year" = "year", 
                  "justice" = "justice",
                  "justiceName" = "justiceName")) %>% 
                   mutate(justiceName = recode(justiceName, 
                                      "SDOConnor" = "O'Connor",
                                      "JPStevens" = "Stevens",
                                      "AScalia" = "Scalia",
                                      "AMKennedy" = "Kennedy",
                                      "DHSouter" = "Souter",
                                      "CThomas" = "Thomas",
                                      "RBGinsburg" = "Ginsburg",
                                      "SGBreyer" = "Breyer",
                                      "JGRoberts" = "Roberts",
                                      "SAAlito" = "Alito",
                                      "SSotomayor" = "Sotomayor",
                                      "EKagan" = "Kagan",
                                      "NMGorsuch" = "Gorsuch",
                                      "BMKavanaugh" = "Kavanaugh")) %>% 
                 mutate(issueArea = recode(issueArea,
                                           "1" = "Criminal Procedure",
                                           "2" = "Civil Rights",
                                           "3" = "First Amendment",
                                           "4" = "Due Process",
                                           "5" = "Privacy",
                                           "6" = "Attorneys",
                                           "7" = "Unions",
                                           "8" = "Economic Activity",
                                           "9" = "Judicial Power",
                                           "10" = "Federalism",
                                           "11" = "Interstate Relations",
                                           "12" = "Federal Taxation",
                                           "13" = "Miscallaneous",
                                           "14" = "Private Action")) %>% 
                 mutate(direction = as.factor(recode(direction,
                                           "1" = "Conservative",
                                           "2" = "Liberal"))) %>% 
                 mutate(conservative = as.factor(ifelse(direction == 
                                                "Conservative", 1, 0))) %>% 
                 mutate(justiceName = as.factor(justiceName),
                        issueArea = as.factor(issueArea)) %>%
                 mutate(year = as.integer(year)) %>% 
                 drop_na()


glm_wfl <- workflow() %>% 
  add_model(logistic_reg() %>%
            set_engine("glm") %>%
            set_mode("classification")) %>% 
  add_recipe(recipe(conservative ~ post_mn + issueArea,
                    data = joined_data) %>% 
               step_interact(~ post_mn * issueArea)
             )

glm_wfl %>% 
  fit(data = joined_data) %>% 
  predict(new_data = joined_data) %>% 
  bind_cols(joined_data %>% select(conservative)) %>% 
  ggplot(aes(y = conservative, x = `.pred_class`)) +
    geom_jitter(height = 0.2, alpha = 0.01) +
    labs(title = "Predicting Direction",
         subtitle = "Using ideology scores",
         x = "Predicted Direction",
         y = "Direction"
         )
```


```{r}
prediction_model <- stan_glm(data = joined_data,
         formula = conservative ~ post_mn + issueArea,
         refresh = 0,
         family = binomial(link = "logit"))

new <- tibble("post_mn" = 3.5,
              "issueArea" = "Privacy")

prediction_posterior <- posterior_predict(prediction_model, newdata = new) %>%
    as_tibble() %>%
    mutate_all(as.numeric) %>% 
    summarize(prob.conservative = mean(`1`))

```


```{r}
new_graph <- tibble("post_mn" = seq(-4, 4, 0.1),
              "issueArea" = "First Amendment")

prediction_posterior <- posterior_predict(prediction_model, 
                                          newdata = new_graph, draws = 4000) %>%
    as_tibble() %>%
    mutate_all(as.numeric) %>% 
    pivot_longer(cols = everything(),
               names_to = "ideology_score",
               values_to = "outcome") %>% 
    mutate(ideology_score = as.numeric(ideology_score)) %>%
    group_by(ideology_score) %>% 
    summarize(proportion_voting = mean(outcome), .groups = "drop") %>% 
    mutate(ideology_score = -4 + .1*(ideology_score - 1))
    
prediction_posterior %>% 
  ggplot(aes(x = ideology_score, y = proportion_voting)) +
    geom_line() +
    labs(title = "Posterior Distribution for Probability of Voting Conservative",
         x = "Ideology",
         y = "Probability") +
    scale_x_continuous(breaks = seq(-4, 4, 1)) +
    theme_linedraw()

```


```{r}
```


```{r}
print(prediction_model, digits = 4)
```


```{r}
```
p1 <- justiceCenteredfixed %>% 
            filter(year == input$year) %>%
            arrange(desc(ideology)) %>% 
            slice(1:5) %>% 
            ggplot(aes(x = justiceName, y = ideology)) +
            geom_col() +
            theme_classic() +
            labs(y = "Ideology Score - Conservative (1) - Liberal (2)",
                 x = "Justice",
                 title = "5 Most Liberal Justices Serving on the Court")
        p1 + transition_time(year) +
            labs(title = "Year: {frame_time}") +
            view_follow(fixed_y = TRUE)

```

```{r}
justiceCenteredfixed %>% 
  arrange(desc(ideology)) %>% 
  ggplot(aes(x = year, y = ideology, color = justiceName)) +
    geom_line()
    
```

